{"version":3,"file":"dlx-pmpro-cloudflare-turnstile.js","mappings":"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","sources":["webpack://dlx-pmpro-turnstile/./src/js/turnstile/index.js"],"sourcesContent":["/**\n * Turnstile JS functionality.\n */\n\nconst addTurnstileToPasswordForm = () => {\n\t// On document load, move #dlx-pmpro-turnstile inside the form.\n\tconst pmproTurnstileContainer = document.querySelector( '#dlx-pmpro-turnstile' );\n\tif ( null === pmproTurnstileContainer ) {\n\t\treturn;\n\t}\n\n\t// Get closest form, and append right before the submit button.\n\tconst pmproForm = document.querySelector( '#lostpasswordform' );\n\tif ( pmproForm ) {\n\t\tconst submitButton = pmproForm.querySelector( 'input[type=\"submit\"]' );\n\t\tif ( submitButton ) {\n\t\t\tsubmitButton.insertAdjacentElement( 'beforebegin', pmproTurnstileContainer );\n\t\t}\n\t}\n};\n\n/**\n * This is the main callback for Cloudflare.\n */\nwindow.onLoadDLXPMProTurnstileCallback = () => {\n\t// Try to add Turnstile to main form.\n\taddTurnstileToPasswordForm();\n\n\t// Get the submit button. If not found, bail.\n\tconst submitButtonSelector = '.login-submit input[type=\"submit\"], #pmpro_submit_span input[type=\"submit\"], #loginform input[type=\"submit\"], #lostpasswordform input[type=\"submit\"], #registerform input[type=\"submit\"]';\n\n\tconst submitButton = document.querySelector( submitButtonSelector );\n\tif ( null === submitButton ) {\n\t\treturn;\n\t}\n\n\t// Mark submit button as disabled.\n\tsubmitButton.setAttribute( 'disabled', 'disabled' );\n\n\t// Now get the main form.\n\tconst pmproForm = submitButton.closest( 'form' );\n\tif ( null === pmproForm ) {\n\t\treturn;\n\t}\n\n\t// Check that turnstile is present.\n\tif ( typeof turnstile === 'undefined' ) {\n\t\treturn;\n\t}\n\n\t/**\n\t * This is the callback for when the user has filled out the textarea.\n\t * We wait until the textarea is filled out to load turnstile to avoid the 300 second timeout of the token.\n\t */\n\tconst turnstileBeginRender = () => {\n\t\t// Now init turnstile.\n\t\tlet retries = 1;\n\t\tconst maxRetries = 5;\n\t\t// eslint-disable-next-line no-undef\n\t\tconst widgetId = turnstile.render( '#dlx-pmpro-turnstile', {\n\t\t\tsitekey: dlxPMPRoTurnstile.siteKey,\n\t\t\tretry: 'never',\n\t\t\tcallback: ( token ) => {\n\t\t\t\t// Re-enable the submit button.\n\t\t\t\tsubmitButton.removeAttribute( 'disabled' );\n\t\t\t\tsetTimeout( () => {\n\t\t\t\t\t// Reset the widget.\n\t\t\t\t\t// eslint-disable-next-line no-undef\n\t\t\t\t\tturnstile.reset( widgetId );\n\t\t\t\t}, 300000 ); // 300 seconds (5 mins).\n\t\t\t},\n\t\t\t'error-callback': ( error ) => {\n\t\t\t\t// if crashed, retry.\n\t\t\t\tif ( 'crashed' === error ) {\n\t\t\t\t\tif ( retries < maxRetries ) {\n\t\t\t\t\t\tconsole.error( 'Turnstile seems not be available. Retrying. (From Cloudflare Turnstile - DLXPMProTurnstile)' );\n\t\t\t\t\t\tdocument.querySelector( '#dlx-pmpro-turnstile' ).insertAdjacentHTML( 'beforeend', '<div class=\"pmpro_message pmpro_error pmpro_captcha_verification_error\">There has been an error communicating with Cloudflare Turnstile (Retrying...).</div>' );\n\t\t\t\t\t\t// eslint-disable-next-line no-undef\n\t\t\t\t\t\tturnstile.reset( widgetId );\n\t\t\t\t\t} else {\n\t\t\t\t\t\tdocument.querySelector( '#dlx-pmpro-turnstile' ).insertAdjacentHTML( 'beforeend', '<div class=\"pmpro_message pmpro_error pmpro_captcha_verification_error\">Could not communicate with Cloudflare Turnstile.</div>' );\n\t\t\t\t\t\tconsole.error( 'Turnstile seems not be available. Max retries reached. (From Cloudflare Turnstile - DLXPMProTurnstile)' );\n\t\t\t\t\t}\n\t\t\t\t\tretries += 1;\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\t// Tokens can be returned in 000*** format.\n\n\t\t\t\t// If interactive challenge failed, reuse the retries var.\n\t\t\t\tconst retryChallengeCodes = [\n\t\t\t\t\t'102',\n\t\t\t\t\t'103',\n\t\t\t\t\t'104',\n\t\t\t\t\t'106',\n\t\t\t\t]; // From: https://developers.cloudflare.com/turnstile/reference/client-side-errors\n\n\t\t\t\t// If interactive challenge failed, check challenge code at beginning of token. Reuse max retries var.\n\t\t\t\tif ( retryChallengeCodes.includes( error.substring( 0, 3 ) ) ) {\n\t\t\t\t\tif ( retries < maxRetries ) {\n\t\t\t\t\t\tconsole.error( 'Turnstile interactive challenge failed. Retrying. (From Cloudflare Turnstile - DLXPMProTurnstile)' );\n\t\t\t\t\t\tdocument.querySelector( '#dlx-pmpro-turnstile' ).insertAdjacentHTML( 'beforeend', '<div class=\"pmpro_message pmpro_error pmpro_captcha_verification_error\">There has been an error communicating with Cloudflare Turnstile (Retrying...).</div>' );\n\t\t\t\t\t\t// eslint-disable-next-line no-undef\n\t\t\t\t\t\tturnstile.reset( widgetId );\n\t\t\t\t\t} else {\n\t\t\t\t\t\tdocument.querySelector( '#dlx-pmpro-turnstile' ).insertAdjacentHTML( 'beforeend', '<div class=\"pmpro_message pmpro_error pmpro_captcha_verification_error\">Could not communicate with Cloudflare Turnstile.</div>' );\n\t\t\t\t\t\tconsole.error( 'Turnstile interactive challenge failed. Max retries reached. (From Cloudflare Turnstile - DLXPMProTurnstile)' );\n\t\t\t\t\t}\n\t\t\t\t\tretries += 1;\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\t// Otherwise display user failed challenge error.\n\t\t\t\tdocument.querySelector( '#dlx-pmpro-turnstile' ).insertAdjacentHTML( 'beforeend', '<div class=\"pmpro_message pmpro_error pmpro_captcha_verification_error\">You could not be verified as human.</div>' );\n\n\t\t\t\t// Remove error after 10 seconds.\n\t\t\t\tsetTimeout( () => {\n\t\t\t\t\tdocument.querySelector( '.pmpro_captcha_verification_error' ).remove();\n\t\t\t\t}, 10000 );\n\t\t\t},\n\t\t\tsize: dlxPMPRoTurnstile.widgetSize, /* can be compact|normal. */\n\t\t\ttheme: dlxPMPRoTurnstile.widgetTheme, /* can be light, dark, auto */\n\t\t\tlanguage: dlxPMPRoTurnstile.language,\n\t\t\tappearance: dlxPMPRoTurnstile.widgetAppearance, /* can be always|execute|`interaction-only` */\n\t\t} );\n\t};\n\n\t// Set up the textarea event. Render Turnstile immediately.\n\tturnstileBeginRender();\n};\n\n"],"names":["addTurnstileToPasswordForm","pmproTurnstileContainer","document","querySelector","pmproForm","submitButton","insertAdjacentElement","window","onLoadDLXPMProTurnstileCallback","submitButtonSelector","setAttribute","closest","turnstile","turnstileBeginRender","retries","maxRetries","widgetId","render","sitekey","dlxPMPRoTurnstile","siteKey","retry","callback","token","removeAttribute","setTimeout","reset","errorCallback","error","console","insertAdjacentHTML","retryChallengeCodes","includes","substring","remove","size","widgetSize","theme","widgetTheme","language","appearance","widgetAppearance"],"sourceRoot":""}